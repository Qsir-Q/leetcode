## 微服务防腐平台

项目介绍

两个领域：项目域  健康域

项目域：运动式治理，比如由于技术升级或者迁云，导致一些基础组件的版本需要升级，那就创建一个project；或者发现某些包的某些版本出现重大bug，需要紧急治理

健康域：把日常出现事故，红线，问题点沉淀下来，日常巡检；可在流量高峰之后即时检测



主要解决问题：

架构失序：最典型的是‘依赖网’问题。由于缺乏统一的依赖治理，服务间调用关系形成了复杂的网状结构

技术债失控：各团队在引入SDK、中间件客户端时存在‘黑盒’操作。例如，一个未经评审的旧版Redis客户端在多个服务中扩散，导致连接池泄漏问题排查了整整两天。技术债的积累和扩散变得不可见、不可控

资源滥用与数据风险：业务为追求性能，普遍存在‘缓存滥用’，把Redis当数据库用，导致缓存与DB数据不一致，且问题根因难以追溯。这不仅仅是性能问题，更是数据一致性的重大隐患

演进与治理脱节：在进行如‘JDK升级’、‘服务拆分’等重大架构活动时，我们缺乏一个平台来**量化进度、评估风险、确保一致性**。治理动作是运动式的，效果难以衡量

**这个平台的本质，是为解决‘**在高速迭代中，如何系统性预防架构腐化、量化技术风险、保障长期演进能力**’这一核心命题而生的。它不是替代监控或告警，而是将治理的触角从‘事后’延伸到‘事中’和‘事前’**



对于防腐的定义：不是消灭所有问题，而是将架构腐化的发现时机从‘故障发生时’（被动告警）提前到‘隐患形成期’（主动预警），并将其控制在可接受、可管理的范围内

**防腐预警**：是通过**长时间序列的数据追踪和模式识别**，发现那些**尚未触发告警但趋势异常**的隐患点。比如，Error日志量在**一周内环比增长了50%**，但绝对值仍很低；或一个服务的平均响应时间正在**以每周5%的斜率缓慢攀升



**目标是把问题‘**遏制在摇篮里，解决在爆发前**’，让治理从被动响应变为主动运营。**



探测器列表：

1. Apache log4j 远程代码执行漏洞
2. FastJson < 1.2.80 反序列化漏洞
3. Jackson-databind 远程代码执行漏洞
4. mysql driver 8.0.x版本默认处理有bug
5. feign 使用 jdk 默认 httpclient
6. feign-client 未配置超时或者超时配置不正确
7. Jedis低版本连接池泄漏问题
8. 服务注册不规范
9. 使用了有问题的框架sdk版本
10. 开启了 trace debug 日志
11. 系统负载异常
12. 网络连接数异常
13. feign client 连接池不够用
14. 服务返回 5xx
15. 服务存在慢请求
16. Redis大Key
17. MQ积压
18. feign调用异常
19. 网关流量响应异常
20. 使用了已下线服务的client
21. cpu利用过低
22. cpu利用义仓
23. cpu发生节流
24. 网络IO过大
25. redis内存利用率过高 七日同比异常
26. 异常类型数目同比增加
27. gc次数过多
28. gc耗时过长
29. 接口qps七日同比异常
30. 24小时有限流
31. 24小时有熔断
32. 接口 rt99 同比异常
33. 接口 rt95 同比异常
34. 存在未知来源的



这个项目是基于什么背景提出的？

1. 当时因缺少规范，导致服务间依赖形成‘网’状而非‘星’状，一个核心服务下线引发大面积故障
2. 团队私下引入未经评审的SDK导致版本冲突，排查耗时极长
3. 缓存被滥用，当作数据库用，导致数据不一致且难以追溯
4. 在重大技术升级以及架构迁移时需要有一个平台去量化进度，以及评估风险点

防腐”这个目标是如何定义的？衡量的核心指标是什么？

说明“防腐”不是消灭问题，而是将问题暴露在可控阶段；是提早发现，和告警的职责不同，当告警触发时，说明已经发生了问题

而防腐平台通过长时间的数据追踪，把一些隐患点暴露出来：

例如：error日志出现 同比 或者 环比的增加，这就说明系统出现了一些隐患

把一些不易发现的问题遏制在非生产环境



“多维度探测器”具体是如何实现的？

不同维度有不同的数据来源，以 依赖混乱 为例，soa上报 服务依赖的的sdk，分为二方包和三方包；创建探测器则可以看到哪些服务依赖了该包



检测算法是如何持续优化

初期基于简单阈值的缓存滥用检测误报率高

后期优化为多维度检测：比如引入 同比 环比，缓存大对象，redis-cpu 等多指标



平台如何实现“治理闭环”？发现一个“腐化”问题后，流程是怎样的？

如果马上会导致业务中断的问题，创建一个 project，指定结束时间，运动式治理，定时发送治理报告，通过im, 邮件等方式通知服务 owner

如果是一个隐患：创建一个 探测器，加入到日常巡检中

可视化分为三个维度：服务，人员，组织

人员可看到以该人员为owner的所有服务列表的问题

组织可看到该组织下的所有服务的问题列表



### 落地与推动

业务方嫌麻烦、担心性能影响、认为不创造业务价值

解决办法：找到愿意尝鲜的，自我要求高的团队；全力支持，持续优化，提高易用性，做出一个成功案例；并以此案例做宣讲

降低门槛：提供一键接入的 Starter，完善文档

数据说服：展示给业务方看，“帮你提前发现了XX个隐患，避免了XX次P级故障”

自上而下：争取技术管理层支持，将部分规则纳入技术规范



### 效果

接入 1800+ 服务，覆盖核心链路所有服务

提前发现了 qps > 500 但是没有配置限流，内存利用率持续升高，日志量太大，jedis版本低导致连接池，log4j 远程控制，fastjson 反序列化漏洞，jackson-databind 远程代码执行漏洞，mysql driver 8.0.x 版本默认失去处理有bug，导致线上事故 等等问题

强力支持多云多活的需求



多维度分析报告：多层级团队leader，架构师，服务owner 不同维度的报表；leader 架构师 关注全体情况以及问题分布；服务owner关注问题种类，解决办法



### 演进与反思

探测器比较封闭，基本都是平台开发人员自己写的；可以让业务方共建，让他们自己提供感兴趣数据的探测器



未来发展：

目前只是多维度的集合，多个探测器的结果是独立开来的，并没有有机整合；后续借助大模型，把所有数据有机整合，精准判定系统水位，系统隐患，以及提供解决方案

与 cicd 平台融合，在发布之前进行卡点





## 服务治理框架



## AI框架与元数据平台



## JDK21/ZGC升级